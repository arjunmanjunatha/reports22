<html>

  <head>
    <title>Report 22</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.0.0-rc.7/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" defer></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0 auto;
        max-width: 800px;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #333;
      }

      .btn {
        display: block;
        width: 200px;
        height: 40px;
        margin: 20px auto;
        background: #3498db;
        color: #fff;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        outline: none;
        transition: background-color 0.3s ease;
      }

      .btn:hover {
        background-color: #2980b9;
      }

      .btn:active {
        background-color: #3498db;
        box-shadow: 0 5px #2980b9;
        transform: translateY(4px);
      }

      #csvFile {
        display: none;
      }

      #uploadLabel {
        display: inline-block;
        margin: 0 auto 20px;
      }

      #statusMessage {
        color: #2ecc71;
        /* Default to the "success" color */
        text-align: center;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }

      tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      #resultsWindow {
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f8f9fa;
        margin-top: 20px;
      }
      #resultsWindow {
    display: none;
}


    </style>

        

  </head>

  <body>
    <h1>Report 22</h1>

    <label id="uploadLabel" for="csvFile" class="btn">Upload CSV</label>
    <input type="file" id="csvFile" accept=".csv">

    <p id="statusMessage"></p>

    <button id="generateReport" class="btn">Generate Report</button>

    <div id="resultsWindow">
      <table id="reportTable">
        <thead>
          <tr>
            <th>Month, Year</th>
            <th>Commission (USD)</th>
          </tr>
        </thead>
        <tbody>
          <!-- tbody is left empty as rows will be appended dynamically -->
        </tbody>
      </table>
    </div>
<button id="generateCancellationsReport" class="btn">Cancellations Report</button>

<div id="cancellationsResultsWindow" style="display: none;">
    <table id="cancellationsReportTable">
    <thead>
        <tr>
            <th>Month, Year</th>
            <th>Total Bookings</th>
            <th>Cancelled Bookings</th>
            <th>Cancellation Percentage</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
</div>

    <button id="saveAsImage" class="btn">Copy Table to Clipboard</button>


    <script>
document.addEventListener('DOMContentLoaded', function() {
    var data = [];
    document.getElementById('csvFile').addEventListener('change', function(e) {
        var file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            complete: function (results) {
                var expectedHeaders = [
                    'Provider', 'Category', 'Booked Date', 'Start Date', 'End Date', 
                    'Booking Status', 'Commission', 'Device', 'Campaign IDs', 'Nights', 
                    'Info', 'Destination', 'Booking Id', 'User Country', 'Payment Status'
                ];
                if(JSON.stringify(results.meta.fields) === JSON.stringify(expectedHeaders)) {
                    data = results.data;
                    document.getElementById('statusMessage').style.color = '#2ecc71';
                    document.getElementById('statusMessage').innerText = 'Ready to generate, boss!';
                } else {
                    document.getElementById('statusMessage').style.color = '#e74c3c';
                    document.getElementById('statusMessage').innerText = 'You trippin, bro?';
                }
            }
        });
    });

    document.getElementById('generateReport').addEventListener('click', function() {
    var file = document.getElementById('csvFile').files[0];
    Papa.parse(file, {
        header: true,
        complete: function (results) {
            var data = results.data;
            var commissions = [];

            // define the variables for subtitle values
            var commissionWithdrawn = 0;
            var commissionAging = 0;
            var commissionAvailable = 0;

            data.forEach(function (record) {
                if(record['Booking Status'] !== 'Canceled') {
                    var endDate = record['End Date'] ? new Date(record['End Date']) : null;
                    var bookedDate = new Date(record['Booked Date']);
                    var payoutDate;

                    if(endDate) {
                        payoutDate = new Date(endDate);
                        payoutDate.setDate(payoutDate.getDate() + 7);
                    } else {
                        payoutDate = new Date(bookedDate);
                        payoutDate.setDate(payoutDate.getDate() + 90);
                    }

                    var monthYear = `${payoutDate.getMonth() + 1}/01/${payoutDate.getFullYear()}`;
                    var existing = commissions.find(com => com.date === monthYear);

                    if(existing) {
                        existing.commission += parseFloat(record['Commission']);
                    } else {
                        commissions.push({ date: monthYear, commission: parseFloat(record['Commission']) });
                    }

                    // Calculate subtitle values
                    switch(record['Payment Status']) {
                        case 'PAID':
                            commissionWithdrawn += parseFloat(record['Commission']);
                            break;
                        case 'PENDING':
                            commissionAging += parseFloat(record['Commission']);
                            break;
                        case 'READY':
                            commissionAvailable += parseFloat(record['Commission']);
                            break;
                    }
                }
            });

            // Remove previous titles and subtitles if they exist
            var oldReportTitle = document.getElementById('reportTitle');
            if(oldReportTitle) oldReportTitle.remove();
            var oldCommissionWithdrawnSubtitle = document.getElementById('commissionWithdrawn');
            if(oldCommissionWithdrawnSubtitle) oldCommissionWithdrawnSubtitle.remove();
            var oldCommissionAgingSubtitle = document.getElementById('commissionAging');
            if(oldCommissionAgingSubtitle) oldCommissionAgingSubtitle.remove();
            var oldCommissionAvailableSubtitle = document.getElementById('commissionAvailable');
            if(oldCommissionAvailableSubtitle) oldCommissionAvailableSubtitle.remove();

            // Update the report title with the current date
            var reportTitle = document.createElement('h1');
            reportTitle.id = 'reportTitle';
            reportTitle.textContent = `Commission Status Projection on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}`;

            // Create and update the subtitles
            var commissionWithdrawnSubtitle = document.createElement('p');
            commissionWithdrawnSubtitle.id = 'commissionWithdrawn';
            commissionWithdrawnSubtitle.textContent = `Commission Withdrawn / Requested: ${commissionWithdrawn.toFixed(2)}`;

            var commissionAgingSubtitle = document.createElement('p');
            commissionAgingSubtitle.id = 'commissionAging';
            commissionAgingSubtitle.textContent = `Commission Aging: ${commissionAging.toFixed(2)}`;

            // Display the commission available to withdraw in the appropriate color
            var commissionAvailableSubtitle = document.createElement('p');
            commissionAvailableSubtitle.id = 'commissionAvailable';
            commissionAvailableSubtitle.textContent = `Commission Available to Withdraw: ${commissionAvailable.toFixed(2)}`;
            if(commissionAvailable > 100) {
                commissionAvailableSubtitle.style.color = 'green';
            } else {
                commissionAvailableSubtitle.style.color = 'red';
            }

            // Append the titles and subtitles to the results window
var resultsWindow = document.getElementById('resultsWindow');

// Get the first child of the results window (which should be the table)
var firstChild = resultsWindow.firstChild;

// Insert the report title and subtitles before the table
resultsWindow.insertBefore(reportTitle, firstChild);
resultsWindow.insertBefore(commissionWithdrawnSubtitle, firstChild);
resultsWindow.insertBefore(commissionAgingSubtitle, firstChild);
resultsWindow.insertBefore(commissionAvailableSubtitle, firstChild);


            // Show the table after data is processed
            resultsWindow.style.display = 'block';

            // Sort the commissions array chronologically
            commissions.sort((a, b) => new Date(a.date) - new Date(b.date));

            var tableBody = document.querySelector('#reportTable tbody');
            tableBody.innerHTML = ''; // clear the table body

            commissions.forEach(function(commission) {
                var row = document.createElement('tr');
                var monthYearCell = document.createElement('td');
                monthYearCell.textContent = new Date(commission.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                var commissionCell = document.createElement('td');
                commissionCell.textContent = commission.commission.toFixed(2);

                row.appendChild(monthYearCell);
                row.appendChild(commissionCell);
                tableBody.appendChild(row);
            });
        }
    });
});


   document.getElementById('generateCancellationsReport').addEventListener('click', function() {
    var cancellations = [];

    data.forEach(function (record) {
        var bookedDate = new Date(record['Booked Date']);
        var monthYear = `${bookedDate.getMonth() + 1}/01/${bookedDate.getFullYear()}`;
        var existing = cancellations.find(com => com.date === monthYear);

        if(existing) {
            existing.totalBookings += 1;
            if(record['Booking Status'].toLowerCase() === 'canceled') {
                existing.cancelledBookings += 1;
            }
        } else {
            cancellations.push({
                date: monthYear,
                totalBookings: 1,
                cancelledBookings: record['Booking Status'].toLowerCase() === 'canceled' ? 1 : 0
            });
        }
    });

    // Sort the cancellations array chronologically
    cancellations.sort((a, b) => new Date(a.date) - new Date(b.date));

    var tableBody = document.querySelector('#cancellationsReportTable tbody');
    tableBody.innerHTML = ''; // clear the table body

    cancellations.forEach(function(cancellation) {
        var row = document.createElement('tr');

        var monthYearCell = document.createElement('td');
        monthYearCell.textContent = new Date(cancellation.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        var totalBookingsCell = document.createElement('td');
        totalBookingsCell.textContent = cancellation.totalBookings;
        var cancelledBookingsCell = document.createElement('td');
        cancelledBookingsCell.textContent = cancellation.cancelledBookings;
        var cancellationPercentageCell = document.createElement('td');
        cancellationPercentageCell.textContent = `${(cancellation.cancelledBookings / cancellation.totalBookings * 100).toFixed(2)}%`;

        row.appendChild(monthYearCell);
        row.appendChild(totalBookingsCell);
        row.appendChild(cancelledBookingsCell);
        row.appendChild(cancellationPercentageCell);
        tableBody.appendChild(row);
    });

    // Show the table after data is processed
    document.getElementById('cancellationsResultsWindow').style.display = 'block';
});
});
</script>

  </body>

</html>
